<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–î–∏–∑–∞–π–Ω–ò–ò ‚Äî —É–º–Ω—ã–π —Ä–µ–º–æ–Ω—Ç</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .step-active{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff}
    .step-inactive{background:#f3f4f6;color:#6b7280}
    .upload-area{border:2px dashed #d1d5db;transition:all .3s ease}
    .upload-area:hover{border-color:#667eea;background:#f8faff}
    .ai-thinking{animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- Header -->
  <header class="bg-white shadow-sm border-b">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center space-x-3">
        <div class="w-10 h-10 bg-gradient-to-r from-purple-500 to-blue-500 rounded-lg flex items-center justify-center">üè†</div>
        <h1 class="text-2xl font-bold text-gray-900">–î–∏–∑–∞–π–Ω–ò–ò</h1>
      </div>
      <div class="text-sm text-gray-600">–£–º–Ω—ã–π —Ä–µ–º–æ–Ω—Ç —Å –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–º –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–æ–º</div>
    </div>
  </header>

  <!-- Steps -->
  <div class="max-w-7xl mx-auto px-4 py-6">
    <div class="flex items-center space-x-4 mb-8">
      <div id="step1Chip" class="step-active px-4 py-2 rounded-full text-sm font-medium">1 –§–æ—Ç–æ –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</div>
      <div class="w-8 h-0.5 bg-gray-300"></div>
      <div id="step2Chip" class="step-inactive px-4 py-2 rounded-full text-sm font-medium">2 –ü–æ–∂–µ–ª–∞–Ω–∏—è</div>
      <div class="w-8 h-0.5 bg-gray-300"></div>
      <div id="step3Chip" class="step-inactive px-4 py-2 rounded-full text-sm font-medium">3 –ì–µ–Ω–µ—Ä–∞—Ü–∏—è</div>
      <div class="w-8 h-0.5 bg-gray-300"></div>
      <div id="step4Chip" class="step-inactive px-4 py-2 rounded-full text-sm font-medium">4 –ü—Ä–∞–≤–∫–∏</div>
      <div class="w-8 h-0.5 bg-gray-300"></div>
      <div id="step5Chip" class="step-inactive px-4 py-2 rounded-full text-sm font-medium">5 –ü–ª–∞–Ω —Ä–µ–º–æ–Ω—Ç–∞</div>
    </div>

    <!-- Step 1: upload & params -->
    <section id="upload-params-section" class="bg-white rounded-xl shadow-lg p-8">
      <h2 class="text-2xl font-bold text-gray-900 mb-6">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ –∏ –∑–∞–¥–∞–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <div>
          <div class="upload-area rounded-lg p-12 text-center cursor-pointer mb-6" id="upload-area">
            <div id="upload-content">
              <div class="text-6xl mb-4">üì∑</div>
              <h3 class="text-xl font-semibold text-gray-700 mb-2">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–æ—Ç–æ —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</h3>
              <p class="text-gray-500">–ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å –ª—é–±—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–¥–æ 10 –ú–ë)</p>
            </div>
            <div id="preview-content" class="hidden">
              <div id="preview-images" class="flex flex-wrap gap-4 justify-center mb-3"></div>
              <p class="text-green-600 font-medium">‚úÖ –§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ</p>
            </div>
          </div>
          <input id="fileInput" type="file" accept="image/*" multiple class="hidden" />
        </div>
        <div>
          <h2 class="text-2xl font-bold text-gray-900 mb-6">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–º–Ω–∞—Ç—ã</h2>
          <div class="grid grid-cols-1 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">–î–ª–∏–Ω–∞ (–º)</label>
              <input id="room-length" type="number" class="w-full px-4 py-3 border rounded-lg" placeholder="4.5">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">–®–∏—Ä–∏–Ω–∞ (–º)</label>
              <input id="room-width" type="number" class="w-full px-4 py-3 border rounded-lg" placeholder="3.2">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">–í—ã—Å–æ—Ç–∞ –ø–æ—Ç–æ–ª–∫–∞ (–º)</label>
              <input id="room-height" type="number" class="w-full px-4 py-3 border rounded-lg" placeholder="2.7">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">–¢–∏–ø –∫–æ–º–Ω–∞—Ç—ã</label>
              <select id="room-type" class="w-full px-4 py-3 border rounded-lg">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>
                <option value="–ì–æ—Å—Ç–∏–Ω–∞—è">–ì–æ—Å—Ç–∏–Ω–∞—è</option>
                <option value="–°–ø–∞–ª—å–Ω—è">–°–ø–∞–ª—å–Ω—è</option>
                <option value="–ö—É—Ö–Ω—è">–ö—É—Ö–Ω—è</option>
                <option value="–í–∞–Ω–Ω–∞—è">–í–∞–Ω–Ω–∞—è</option>
                <option value="–ö–∞–±–∏–Ω–µ—Ç">–ö–∞–±–∏–Ω–µ—Ç</option>
                <option value="–î–µ—Ç—Å–∫–∞—è">–î–µ—Ç—Å–∫–∞—è</option>
              </select>
            </div>
          </div>
        </div>
      </div>
      <button id="next-to-wishes" class="mt-6 bg-gradient-to-r from-purple-500 to-blue-500 text-white px-8 py-3 rounded-lg font-medium hover:from-purple-600 hover:to-blue-600 transition">
        –î–∞–ª–µ–µ: –í–∞—à–∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è ‚Üí
      </button>
    </section>

    <!-- Step 2: wishes -->
    <section id="wishes-section" class="hidden bg-white rounded-xl shadow-lg p-8">
      <h2 class="text-2xl font-bold text-gray-900 mb-6">–í–∞—à–∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <div>
          <div class="upload-area rounded-lg p-12 text-center cursor-pointer mb-6" id="ref-upload-area">
            <div id="ref-upload-content">
              <div class="text-6xl mb-4">üñºÔ∏è</div>
              <h3 class="text-xl font-semibold text-gray-700 mb-2">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ä–µ—Ñ–µ—Ä–µ–Ω—Å—ã —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</h3>
              <p class="text-gray-500">–ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–æ 10 –ú–ë</p>
            </div>
            <div id="ref-preview-content" class="hidden">
              <div id="ref-preview-images" class="flex flex-wrap gap-4 justify-center mb-3"></div>
              <p class="text-green-600 font-medium">‚úÖ –†–µ—Ñ–µ—Ä–µ–Ω—Å—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã</p>
            </div>
          </div>
          <input id="refFileInput" type="file" accept="image/*" multiple class="hidden" />
        </div>
        <div>
          <div class="grid grid-cols-1 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">–°—Ç–∏–ª—å –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞</label>
              <select id="style" class="w-full px-4 py-3 border rounded-lg">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∏–ª—å</option>
                <option>–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π</option>
                <option>–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π</option>
                <option>–°–∫–∞–Ω–¥–∏–Ω–∞–≤—Å–∫–∏–π</option>
                <option>–õ–æ—Ñ—Ç</option>
                <option>–ú–∏–Ω–∏–º–∞–ª–∏–∑–º</option>
                <option>–•–∞–π-—Ç–µ–∫</option>
                <option>–≠–∫–æ</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">–¶–≤–µ—Ç–æ–≤–∞—è –ø–∞–ª–∏—Ç—Ä–∞</label>
              <input id="colors" type="text" class="w-full px-4 py-3 border rounded-lg" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —Å–≤–µ—Ç–ª—ã–µ –æ—Ç—Ç–µ–Ω–∫–∏, –∞–∫—Ü–µ–Ω—Ç—ã –∑–µ–ª—ë–Ω–æ–≥–æ">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è</label>
              <textarea id="additional" rows="4" class="w-full px-4 py-3 border rounded-lg" placeholder="–û–ø–∏—à–∏—Ç–µ, —á—Ç–æ –±—ã –≤—ã —Ö–æ—Ç–µ–ª–∏ –≤–∏–¥–µ—Ç—å –≤ –¥–∏–∑–∞–π–Ω–µ"></textarea>
            </div>
          </div>
        </div>
      </div>
      <div class="flex justify-end mt-6">
        <button id="generate-design" class="bg-gradient-to-r from-purple-500 to-blue-500 text-white px-8 py-3 rounded-lg font-medium hover:from-purple-600 hover:to-blue-600 transition">
          –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–∏–∑–∞–π–Ω ‚Üí
        </button>
      </div>
    </section>

    <!-- Step 3: generation progress -->
    <section id="generation-section" class="hidden">
      <div class="bg-white rounded-xl shadow-lg p-8 text-center">
        <div class="mb-6">
          <div class="ai-thinking text-6xl mb-4">ü§ñ</div>
          <p id="progress-text" class="text-xl text-gray-700">–ì–æ—Ç–æ–≤–∏–º –≤–∞—à –¥–∏–∑–∞–π–Ω...</p>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-4">
          <div id="progress-bar" class="bg-gradient-to-r from-purple-500 to-blue-500 h-4 rounded-full transition-all" style="width: 0%"></div>
        </div>
      </div>
    </section>

    <!-- Step 4: result + chat -->
    <section id="result-section" class="hidden bg-white rounded-xl shadow-lg p-8">
      <h2 class="text-2xl font-bold text-gray-900 mb-6">–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–∏–∑–∞–π–Ω–∞</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <div>
          <img id="result-image" src="" alt="–†–µ–∑—É–ª—å—Ç–∞—Ç" class="w-full h-auto rounded-lg hidden">
          <div id="result-placeholder" class="w-full h-64 bg-gray-100 rounded-lg flex items-center justify-center">
            <div class="ai-thinking text-4xl">‚åõ</div>
          </div>
        </div>
        <div>
          <div id="chat-container" class="h-64 overflow-y-auto mb-4 p-4 border rounded-lg bg-gray-50">
            <!-- —á–∞—Ç -->
          </div>
          <div class="flex space-x-2">
            <input id="chat-input" type="text" class="flex-grow px-4 py-2 border rounded-lg" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è –ø–æ –ø—Ä–∞–≤–∫–∞–º">
            <button id="send-message" class="bg-gradient-to-r from-purple-500 to-blue-500 text-white px-4 py-2 rounded-lg">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
          </div>
          <div class="flex space-x-4 mt-4">
            <button id="regenerate-design" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg flex items-center space-x-2">
              <span>–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</span>
            </button>
            <button id="approve-design" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg flex items-center space-x-2">
              <span>–£—Ç–≤–µ—Ä–¥–∏—Ç—å</span>
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- Step 5: plan -->
    <section id="plan-section" class="hidden bg-white rounded-xl shadow-lg p-8">
      <h2 class="text-2xl font-bold text-gray-900 mb-6">–ü–ª–∞–Ω —Ä–µ–º–æ–Ω—Ç–∞</h2>
      <p class="text-gray-700">–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è –ø–ª–∞–Ω —Ä–µ–º–æ–Ω—Ç–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —É—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω–æ–≥–æ –¥–∏–∑–∞–π–Ω–∞.</p>
    </section>
  </div>

  <script>
    const $ = sel => document.querySelector(sel);
    const show = el => el.classList.remove('hidden');
    const hide = el => el.classList.add('hidden');

    let currentStep = 1;
    let uploadedFiles = [];
    let referenceFiles = [];
    let lastPrompt = '';
    let lastFeedback = '';

    function setStep(n){
      currentStep = n;
      ['step1Chip','step2Chip','step3Chip','step4Chip','step5Chip'].forEach((id,i)=>{
        const el = $('#' + id);
        i+1 === n ? el.className = 'step-active px-4 py-2 rounded-full text-sm font-medium'
                  : el.className = 'step-inactive px-4 py-2 rounded-full text-sm font-medium';
      });
      hide($('#upload-params-section'));
      hide($('#wishes-section'));
      hide($('#generation-section'));
      hide($('#result-section'));
      hide($('#plan-section'));
      if(n===1) show($('#upload-params-section'));
      if(n===2) show($('#wishes-section'));
      if(n===3) show($('#generation-section'));
      if(n===4) show($('#result-section'));
      if(n===5) show($('#plan-section'));
    }

    function handleUploads(input, arr, previewContainer){
      const files = Array.from(input.files || []);
      files.forEach(f=>{
        if(!f.type.startsWith('image/')){
          alert('–ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
          return;
        }
        arr.push(f);
      });
      previewContainer.innerHTML = '';
      arr.forEach(f=>{
        const img = document.createElement('img');
        img.src = URL.createObjectURL(f);
        img.className = 'w-24 h-24 object-cover rounded';
        previewContainer.appendChild(img);
      });
    }

    $('#upload-area').addEventListener('click',()=> $('#fileInput').click());
    $('#fileInput').addEventListener('change', e=>{
      uploadedFiles = [];
      handleUploads(e.target, uploadedFiles, $('#preview-images'));
      if(uploadedFiles.length){
        hide($('#upload-content'));
        show($('#preview-content'));
      }
    });

    $('#upload-area').addEventListener('dragover', e=>{
      e.preventDefault();
      e.stopPropagation();
    });
    $('#upload-area').addEventListener('drop', e=>{
      e.preventDefault();
      e.stopPropagation();
      const dtFiles = e.dataTransfer.files;
      uploadedFiles = [];
      handleUploads({ files: dtFiles }, uploadedFiles, $('#preview-images'));
      if(uploadedFiles.length){
        hide($('#upload-content'));
        show($('#preview-content'));
      }
    });

    $('#ref-upload-area').addEventListener('click',()=> $('#refFileInput').click());
    $('#refFileInput').addEventListener('change', e=>{
      referenceFiles = [];
      handleUploads(e.target, referenceFiles, $('#ref-preview-images'));
      if(referenceFiles.length){
        hide($('#ref-upload-content'));
        show($('#ref-preview-content'));
      }
    });

    $('#ref-upload-area').addEventListener('dragover', e=>{
      e.preventDefault();
      e.stopPropagation();
    });
    $('#ref-upload-area').addEventListener('drop', e=>{
      e.preventDefault();
      e.stopPropagation();
      const dtFiles = e.dataTransfer.files;
      referenceFiles = [];
      handleUploads({ files: dtFiles }, referenceFiles, $('#ref-preview-images'));
      if(referenceFiles.length){
        hide($('#ref-upload-content'));
        show($('#ref-preview-content'));
      }
    });

    $('#next-to-wishes').addEventListener('click', ()=>{
      if(!uploadedFiles.length){
        alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ –∫–æ–º–Ω–∞—Ç—ã');
        return;
      }
      lastPrompt = '';
      setStep(2);
      window.scrollTo({top:0,behavior:'smooth'});
    });

    $('#generate-design').addEventListener('click', async ()=>{
      if(!uploadedFiles.length){
        alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ –∫–æ–º–Ω–∞—Ç—ã');
        return;
      }
      const style = $('#style').value.trim();
      const colors = $('#colors').value.trim();
      const additional = $('#additional').value.trim();
      const roomLength = $('#room-length').value || '';
      const roomWidth = $('#room-width').value || '';
      const roomHeight = $('#room-height').value || '';
      const roomType = $('#room-type').value || '';

      let prompt = `–°—Ç–∏–ª—å: ${style || '–ª—é–±–æ–π'}. –¶–≤–µ—Ç–∞: ${colors || '–Ω–µ —É–∫–∞–∑–∞–Ω—ã'}. –î–æ–ø: ${additional || '–Ω–µ—Ç'}.
–†–∞–∑–º–µ—Ä—ã: ${roomLength}x${roomWidth}x${roomHeight}. –¢–∏–ø: ${roomType || '–Ω–µ —É–∫–∞–∑–∞–Ω'}.`;
      lastPrompt = prompt;

      setStep(3);
      updateProgress(10, '–ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ‚Ä¶');

      try{
        const fd = new FormData();
        [...uploadedFiles, ...referenceFiles].forEach(f=> fd.append('image', f, f.name));
        fd.append('prompt', lastPrompt);

        updateProgress(25, '–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä‚Ä¶');
        const res = await fetch('/api/redesign', { method:'POST', body: fd });

        if(!res.ok){
          const t = await res.text();
          throw new Error(`API –æ—à–∏–±–∫–∞ ${res.status}: ${t}`);
        }

        updateProgress(65, '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–∏–∑–∞–π–Ω–∞‚Ä¶');
        const data = await res.json();
        const imgSrc = data.image_base64
          ? `data:image/png;base64,${data.image_base64}`
          : data.image_url;

        updateProgress(95, '–ì–æ—Ç–æ–≤–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç‚Ä¶');
        const resultImg = $('#result-image');
        resultImg.src = imgSrc;
        resultImg.onload = ()=>{
          hide($('#result-placeholder'));
          show(resultImg);
        };

        updateProgress(100, '–ì–æ—Ç–æ–≤–æ!');
        setStep(4);
      }catch(err){
        console.error(err);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–∏–∑–∞–π–Ω: ' + err.message);
        setStep(2);
      }
    });

    function updateProgress(pct, text){
      $('#progress-bar').style.width = pct + '%';
      $('#progress-text').textContent = text;
    }

    // ---------- —á–∞—Ç –∏ –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è ----------
    function addMessage(who, text){
      const c = $('#chat-container');
      const wrap = document.createElement('div');
      wrap.className = 'mb-3';
      const b = document.createElement('div');
      b.className = (who==='ai' ? 'bg-blue-100' : 'bg-gray-100') + ' rounded-lg p-3 inline-block';
      b.innerHTML = `<strong>${who==='ai'?'–ò–ò':'–í—ã'}:</strong> ${text}`;
      wrap.appendChild(b);
      c.appendChild(wrap);
      c.scrollTop = c.scrollHeight;
    }

    $('#send-message').addEventListener('click', ()=>{
      const val = $('#chat-input').value.trim();
      if(!val) return;
      lastFeedback = val;
      addMessage('user', val);
      $('#chat-input').value = '';
      setTimeout(()=> addMessage('ai','–ü—Ä–∏–Ω—è—Ç–æ! –ù–∞–∂–º–∏—Ç–µ ¬´–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å¬ª.'),
                 500);
    });

    async function regenerateDesign(){
      if(!uploadedFiles.length){
        alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ.');
        return;
      }
      if(!lastFeedback){
        alert('–°–Ω–∞—á–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø—Ä–∞–≤–∫–∞–º–∏.');
        return;
      }
      const btn = $('#regenerate-design');
      btn.disabled = true;
      addMessage('ai','–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä—É—é —Å —É—á—ë—Ç–æ–º –ø—Ä–∞–≤–æ–∫‚Ä¶');
      hide($('#result-image'));
      show($('#result-placeholder'));
      try{
        const fd = new FormData();
        [...uploadedFiles, ...referenceFiles].forEach(f=> fd.append('image', f, f.name));
        fd.append('prompt', `${lastPrompt}. ${lastFeedback}`.trim());

        const res = await fetch('/api/redesign', { method:'POST', body: fd });
        if(!res.ok){
          const t = await res.text();
          throw new Error(`API –æ—à–∏–±–∫–∞ ${res.status}: ${t}`);
        }

        const data = await res.json();
        const imgSrc = data.image_base64
          ? `data:image/png;base64,${data.image_base64}`
          : data.image_url;

        const resultImg = $('#result-image');
        resultImg.src = imgSrc;
        resultImg.onload = ()=>{
          hide($('#result-placeholder'));
          show(resultImg);
        };
      }catch(err){
        console.error(err);
        addMessage('ai', '–û—à–∏–±–∫–∞: ' + err.message);
        hide($('#result-image'));
        $('#result-placeholder').textContent = '–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏';
      }finally{
        btn.disabled = false;
      }
    }

    $('#regenerate-design').addEventListener('click', regenerateDesign);

    $('#approve-design').addEventListener('click', ()=>{
      setStep(5);
      window.scrollTo({top:0,behavior:'smooth'});
    });

    setStep(1);
  </script>
</body>
</html>
