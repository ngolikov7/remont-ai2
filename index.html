<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–î–∏–∑–∞–π–Ω–ò–ò ‚Äî —É–º–Ω—ã–π —Ä–µ–º–æ–Ω—Ç</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .step-active{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff}
    .step-inactive{background:#f3f4f6;color:#6b7280}
    .upload-area{border:2px dashed #d1d5db;transition:all .3s ease}
    .upload-area:hover{border-color:#667eea;background:#f8faff}
    .ai-thinking{animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- Header -->
  <header class="bg-white shadow-sm border-b">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center space-x-3">
        <div class="w-10 h-10 bg-gradient-to-r from-purple-500 to-blue-500 rounded-lg flex items-center justify-center">üè†</div>
        <h1 class="text-2xl font-bold text-gray-900">–î–∏–∑–∞–π–Ω–ò–ò</h1>
      </div>
      <div class="text-sm text-gray-600">–£–º–Ω—ã–π —Ä–µ–º–æ–Ω—Ç —Å –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–º –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–æ–º</div>
    </div>
  </header>

  <!-- Steps -->
  <div class="max-w-7xl mx-auto px-4 py-6">
    <div class="flex items-center space-x-4 mb-8">
      <div id="step1Chip" class="step-active px-4 py-2 rounded-full text-sm font-medium">1 –§–æ—Ç–æ –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</div>
      <div class="w-8 h-0.5 bg-gray-300"></div>
      <div id="step2Chip" class="step-inactive px-4 py-2 rounded-full text-sm font-medium">2 –ü–æ–∂–µ–ª–∞–Ω–∏—è</div>
      <div class="w-8 h-0.5 bg-gray-300"></div>
      <div id="step3Chip" class="step-inactive px-4 py-2 rounded-full text-sm font-medium">3 –ì–µ–Ω–µ—Ä–∞—Ü–∏—è</div>
      <div class="w-8 h-0.5 bg-gray-300"></div>
      <div id="step4Chip" class="step-inactive px-4 py-2 rounded-full text-sm font-medium">4 –ü—Ä–∞–≤–∫–∏</div>
      <div class="w-8 h-0.5 bg-gray-300"></div>
      <div id="step5Chip" class="step-inactive px-4 py-2 rounded-full text-sm font-medium">5 –ü–ª–∞–Ω —Ä–µ–º–æ–Ω—Ç–∞</div>
    </div>

    <!-- Step 1: upload & params -->
    <section id="upload-params-section" class="bg-white rounded-xl shadow-lg p-8">
      <h2 class="text-2xl font-bold text-gray-900 mb-6">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ –∏ –∑–∞–¥–∞–π—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <div>
          <div class="upload-area rounded-lg p-12 text-center cursor-pointer mb-6" id="upload-area">
            <div id="upload-content">
              <div class="text-6xl mb-4">üì∑</div>
              <h3 class="text-xl font-semibold text-gray-700 mb-2">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–æ—Ç–æ —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</h3>
              <p class="text-gray-500">–ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å –ª—é–±—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–¥–æ 10 –ú–ë)</p>
            </div>
            <div id="preview-content" class="hidden">
              <div id="preview-images" class="flex flex-wrap gap-4 justify-center mb-3"></div>
              <p class="text-green-600 font-medium">‚úÖ –§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ</p>
            </div>
          </div>
          <input id="fileInput" type="file" accept="image/*" multiple class="hidden" />
        </div>
        <div>
          <h2 class="text-2xl font-bold text-gray-900 mb-6">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–º–Ω–∞—Ç—ã</h2>
          <div class="grid grid-cols-1 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">–î–ª–∏–Ω–∞ (–º)</label>
              <input id="room-length" type="number" class="w-full px-4 py-3 border rounded-lg" placeholder="4.5">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">–®–∏—Ä–∏–Ω–∞ (–º)</label>
              <input id="room-width" type="number" class="w-full px-4 py-3 border rounded-lg" placeholder="3.2">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">–í—ã—Å–æ—Ç–∞ –ø–æ—Ç–æ–ª–∫–∞ (–º)</label>
              <input id="room-height" type="number" class="w-full px-4 py-3 border rounded-lg" placeholder="2.7">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">–¢–∏–ø –∫–æ–º–Ω–∞—Ç—ã</label>
              <select id="room-type" class="w-full px-4 py-3 border rounded-lg">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ</option>
                <option value="–ì–æ—Å—Ç–∏–Ω–∞—è">–ì–æ—Å—Ç–∏–Ω–∞—è</option>
                <option value="–°–ø–∞–ª—å–Ω—è">–°–ø–∞–ª—å–Ω—è</option>
                <option value="–ö—É—Ö–Ω—è">–ö—É—Ö–Ω—è</option>
                <option value="–í–∞–Ω–Ω–∞—è">–í–∞–Ω–Ω–∞—è</option>
                <option value="–ö–∞–±–∏–Ω–µ—Ç">–ö–∞–±–∏–Ω–µ—Ç</option>
                <option value="–î–µ—Ç—Å–∫–∞—è">–î–µ—Ç—Å–∫–∞—è</option>
              </select>
            </div>
          </div>
        </div>
      </div>
      <button id="next-to-wishes" class="mt-6 bg-gradient-to-r from-purple-500 to-blue-500 text-white px-8 py-3 rounded-lg font-medium hover:from-purple-600 hover:to-blue-600 transition">
        –î–∞–ª–µ–µ: –í–∞—à–∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è ‚Üí
      </button>
    </section>

    <!-- Step 2: wishes -->
    <section id="wishes-section" class="hidden bg-white rounded-xl shadow-lg p-8">
      <h2 class="text-2xl font-bold text-gray-900 mb-6">–í–∞—à–∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <div>
          <div class="upload-area rounded-lg p-12 text-center cursor-pointer mb-6" id="ref-upload-area">
            <div id="ref-upload-content">
              <div class="text-6–ª mb-4">üñºÔ∏è</div>
              <h3 class="text-xl font-semibold text-gray-700 mb-2">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ä–µ—Ñ–µ—Ä–µ–Ω—Å—ã —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</h3>
              <p class="text-gray-500">–ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–æ 10 –ú–ë</p>
            </div>
            <div id="ref-preview-content" class="hidden">
              <div id="ref-preview-images" class="flex flex-wrap gap-4 justify-center mb-3"></div>
              <p class="text-green-600 font-medium">‚úÖ –†–µ—Ñ–µ—Ä–µ–Ω—Å—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã</p>
            </div>
          </div>
          <input id="refFileInput" type="file" accept="image/*" multiple class="hidden" />
        </div>
        <div>
          <div class="grid grid-cols-1 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">–°—Ç–∏–ª—å –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞</label>
              <select id="style" class="w-full px-4 py-3 border rounded-lg">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∏–ª—å</option>
                <option>–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π</option>
                <option>–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π</option>
                <option>–°–∫–∞–Ω–¥–∏–Ω–∞–≤—Å–∫–∏–π</option>
                <option>–õ–æ—Ñ—Ç</option>
                <option>–ú–∏–Ω–∏–º–∞–ª–∏–∑–º</option>
                <option>–ù–µ–æ–∫–ª–∞—Å—Å–∏–∫–∞</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">–ë—é–¥–∂–µ—Ç (—Ä—É–±.)</label>
              <select id="budget" class="w-full px-4 py-3 border rounded-lg">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±—é–¥–∂–µ—Ç</option>
                <option>–î–æ 100 000</option>
                <option>100 000 ‚Äì 300 000</option>
                <option>300 000 ‚Äì 500 000</option>
                <option>500 000 ‚Äì 1 000 000</option>
                <option>–ë–æ–ª–µ–µ 1 000 000</option>
              </select>
            </div>
          </div>
          <div class="mt-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è</label>
            <textarea id="additional-wishes" rows="4" class="w-full px-4 py-3 border rounded-lg" placeholder="–¶–≤–µ—Ç–∞, –º–µ–±–µ–ª—å, –æ—Å–≤–µ—â–µ–Ω–∏–µ, –æ—Å–æ–±—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è‚Ä¶"></textarea>
          </div>
        </div>
      </div>
      <button id="start-generation" class="mt-6 bg-gradient-to-r from-green-500 to-blue-500 text-white px-8 py-3 rounded-lg font-medium hover:from-green-600 hover:to-blue-600 transition">
        üé® –ù–∞—á–∞—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –¥–∏–∑–∞–π–Ω–∞
      </button>
    </section>

    <!-- Step 3: generation -->
    <section id="generation-section" class="hidden bg-white rounded-xl shadow-lg p-8">
      <div class="text-center">
        <div class="ai-thinking text-6xl mb-4">ü§ñ</div>
        <h2 class="text-2xl font-bold text-gray-900 mb-4">–ò–ò —Å–æ–∑–¥–∞–µ—Ç –¥–∏–∑–∞–π–Ω –≤–∞—à–µ–π –∫–æ–º–Ω–∞—Ç—ã</h2>
        <p id="progress-text" class="text-gray-600 mb-6">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è‚Ä¶</p>
        <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
          <div id="progress-bar" class="bg-gradient-to-r from-purple-500 to-blue-500 h-2 rounded-full" style="width:0%"></div>
        </div>
      </div>
    </section>

    <!-- Step 4: review -->
    <section id="review-section" class="hidden bg-white rounded-xl shadow-lg p-8">
      <h2 class="text-2xl font-bold text-gray-900 mb-6">–í–∞—à –Ω–æ–≤—ã–π –¥–∏–∑–∞–π–Ω –≥–æ—Ç–æ–≤!</h2>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div>
          <h3 class="text-lg font-semibold mb-4">–ò—Å—Ö–æ–¥–Ω–æ–µ —Ñ–æ—Ç–æ</h3>
          <div class="bg-gray-100 rounded-lg p-4 min-h-64 flex items-center justify-center">
            <img id="final-origin" class="max-h-56 rounded" alt="–ò—Å—Ö–æ–¥–Ω–æ–µ"/>
          </div>
        </div>
        <div>
          <h3 class="text-lg font-semibold mb-4">–ù–æ–≤—ã–π –¥–∏–∑–∞–π–Ω</h3>
          <div class="bg-gradient-to-br from-blue-100 to-purple-100 rounded-lg p-4 min-h-64 flex items-center justify-center">
            <img id="result-image" class="max-h-60 object-contain hidden" alt="–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–∏–∑–∞–π–Ω"/>
            <span id="result-placeholder" class="text-gray-700 text-center">‚è≥ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é‚Ä¶</span>
          </div>
        </div>
      </div>

      <div class="mt-8">
        <h3 class="text-lg font-semibold mb-4">–ß–∞—Ç —Å –ò–ò –¥–ª—è –ø—Ä–∞–≤–æ–∫</h3>
        <div id="chat-container" class="border rounded-lg h-64 overflow-y-auto p-4 mb-4 bg-gray-50">
          <div class="mb-3">
            <div class="bg-blue-100 rounded-lg p-3 inline-block">
              <strong>–ò–ò:</strong> –î–∏–∑–∞–π–Ω –≥–æ—Ç–æ–≤! –ß—Ç–æ —Ö–æ—Ç–µ–ª–∏ –±—ã –∏–∑–º–µ–Ω–∏—Ç—å?
            </div>
          </div>
        </div>
        <div class="flex space-x-2">
          <input id="chat-input" type="text" class="flex-1 px-4 py-2 border rounded-lg" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å‚Ä¶">
          <button id="send-message" class="bg-purple-500 text-white px-6 py-2 rounded-lg hover:bg-purple-600">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>

        <div class="flex space-x-4 mt-6">
          <button id="regenerate-design" class="bg-yellow-500 text-white px-6 py-3 rounded-lg hover:bg-yellow-600">üîÑ –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
          <button id="approve-design" class="bg-green-500 text-white px-6 py-3 rounded-lg hover:bg-green-600">‚úÖ –£—Ç–≤–µ—Ä–¥–∏—Ç—å –¥–∏–∑–∞–π–Ω</button>
        </div>
      </div>
    </section>

    <!-- Step 5: plan -->
    <section id="plan-section" class="hidden bg-white rounded-xl shadow-lg p-8">
      <h2 class="text-2xl font-bold text-gray-900 mb-6">–ü–ª–∞–Ω —Ä–µ–º–æ–Ω—Ç–∞ –∏ —Å–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫</h2>
      <p class="text-gray-600">–ó–¥–µ—Å—å –±—É–¥–µ—Ç —Å–º–µ—Ç–∞, —ç—Ç–∞–ø—ã —Ä–∞–±–æ—Ç –∏ —Å–ø–∏—Å–æ–∫ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ ‚Äî –¥–æ–±–∞–≤–∏–º –ø–æ—Å–ª–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–∏–∑–∞–π–Ω–∞.</p>
    </section>
  </div>

  <script>
    // ---------- helpers ----------
    const $ = (s, root = document) => root.querySelector(s);
    const show = el => el.classList.remove('hidden');
    const hide = el => el.classList.add('hidden');

    const chips = ['step1','step2','step3','step4','step5'].map(id => $('#'+id+'Chip'));
    function setStep(n){
      const sections = ['upload-params','wishes','generation','review','plan'].map(id => $('#'+id+'-section'));
      sections.forEach((el,i)=> i===n-1 ? show(el) : hide(el));
      chips.forEach((el,i)=> el.className = (i===n-1) ? 'step-active px-4 py-2 rounded-full text-sm font-medium' : 'step-inactive px-4 py-2 rounded-full text-sm font-medium');
      window.scrollTo({top:0,behavior:'smooth'});
    }

    // ---------- state ----------
    let uploadedFiles = [];
    let referenceFiles = [];
    let lastPrompt = '';
    let lastFeedback = '';

    // ---------- step 1 ----------
    const fileInput = $('#fileInput');
    const uploadArea = $('#upload-area');
    uploadArea.addEventListener('click', ()=> fileInput.click());
    uploadArea.addEventListener('dragover', e=>{e.preventDefault(); uploadArea.classList.add('bg-blue-50')});
    uploadArea.addEventListener('dragleave', ()=> uploadArea.classList.remove('bg-blue-50'));
    uploadArea.addEventListener('drop', e=>{
      e.preventDefault();
      uploadArea.classList.remove('bg-blue-50');
      if(e.dataTransfer.files) handleFiles(e.dataTransfer.files);
    });
    fileInput.addEventListener('change', ()=> { handleFiles(fileInput.files); fileInput.value = ''; });

    function handleFiles(fileList){
      const files = Array.from(fileList || []);
      files.forEach(f=>{
        if(f.size > 10*1024*1024){
          alert('–§–∞–π–ª –±–æ–ª—å—à–µ 10 –ú–ë');
          return;
        }
        if(f.type && !f.type.startsWith('image/')){
          alert('–ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
          return;
        }
        uploadedFiles.push(f);
        const reader = new FileReader();
        reader.onload = e=>{
          const img = document.createElement('img');
          img.src = e.target.result;
          img.className = 'max-h-32 rounded mx-auto';
          $('#preview-images').appendChild(img);
        };
        reader.readAsDataURL(f);
      });
      if(uploadedFiles.length > 0){
        hide($('#upload-content'));
        show($('#preview-content'));
        show($('#next-to-wishes'));
        const r = new FileReader();
        r.onload = e=> { $('#final-origin').src = e.target.result; };
        r.readAsDataURL(uploadedFiles[0]);
      }
    }

    $('#next-to-wishes').addEventListener('click', ()=> setStep(2));

    // ---------- step 2 references ----------
    const refFileInput = $('#refFileInput');
    const refUploadArea = $('#ref-upload-area');
    function handleRefFiles(fileList){
      const files = Array.from(fileList || []);
      files.forEach(f=>{
        if(f.size > 10*1024*1024){
          alert('–§–∞–π–ª –±–æ–ª—å—à–µ 10 –ú–ë');
          return;
        }
        if(f.type && !f.type.startsWith('image/')){
          alert('–ú–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
          return;
        }
        referenceFiles.push(f);
        const reader = new FileReader();
        reader.onload = e=>{
          const img = document.createElement('img');
          img.src = e.target.result;
          img.className = 'max-h-32 rounded mx-auto';
          $('#ref-preview-images').appendChild(img);
        };
        reader.readAsDataURL(f);
      });
      if(referenceFiles.length > 0){
        hide($('#ref-upload-content'));
        show($('#ref-preview-content'));
      }
    }
    refUploadArea.addEventListener('click', ()=> refFileInput.click());
    refUploadArea.addEventListener('dragover', e=>{e.preventDefault(); refUploadArea.classList.add('bg-blue-50')});
    refUploadArea.addEventListener('dragleave', ()=> refUploadArea.classList.remove('bg-blue-50'));
    refUploadArea.addEventListener('drop', e=>{
      e.preventDefault();
      refUploadArea.classList.remove('bg-blue-50');
      if(e.dataTransfer.files) handleRefFiles(e.dataTransfer.files);
    });
    refFileInput.addEventListener('change', ()=> { handleRefFiles(refFileInput.files); refFileInput.value = ''; });

    // ---------- step 2 ‚Üí 3 (call API) ----------
    $('#start-generation').addEventListener('click', async ()=>{
      if(!uploadedFiles.length){ alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ.'); return; }

      const roomType = $('#room-type').value || '–∫–æ–º–Ω–∞—Ç–∞';
      const style = $('#style').value || '—Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å—Ç–∏–ª—å';
      const wishes = $('#additional-wishes').value || '';
      const length = $('#room-length').value;
      const width = $('#room-width').value;
      const height = $('#room-height').value;
      let dims = '';
      if (length || width || height) {
        if (length && width && height) {
          dims = ` –†–∞–∑–º–µ—Ä—ã: ${length}√ó${width}√ó${height} –º.`;
        } else {
          const parts = [];
          if (length) parts.push(`–¥–ª–∏–Ω–∞ ${length} –º`);
          if (width) parts.push(`—à–∏—Ä–∏–Ω–∞ ${width} –º`);
          if (height) parts.push(`–≤—ã—Å–æ—Ç–∞ ${height} –º`);
          dims = ` –†–∞–∑–º–µ—Ä—ã: ${parts.join(', ')}.`;
        }
      }
      lastPrompt = `–°–¥–µ–ª–∞–π —Ä–µ–¥–∏–∑–∞–π–Ω: ${roomType}, —Å—Ç–∏–ª—å: ${style}. ${wishes}${dims}`.trim();

      setStep(3);
      updateProgress(10, '–ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–æ—Ç–æ‚Ä¶');

      try{
        const fd = new FormData();
        [...uploadedFiles, ...referenceFiles].forEach(f=> fd.append('image', f, f.name));
        fd.append('prompt', lastPrompt);

        updateProgress(25, '–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä‚Ä¶');
        const res = await fetch('/api/redesign', { method:'POST', body: fd });

        if(!res.ok){
          const t = await res.text();
          throw new Error(`API –æ—à–∏–±–∫–∞ ${res.status}: ${t}`);
        }

        updateProgress(65, '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–∏–∑–∞–π–Ω–∞‚Ä¶');
        const data = await res.json();
        const imgSrc = data.image_base64
          ? `data:image/png;base64,${data.image_base64}`
          : data.image_url;

        updateProgress(95, '–ì–æ—Ç–æ–≤–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç‚Ä¶');
        const resultImg = $('#result-image');
        resultImg.src = imgSrc;
        resultImg.onload = ()=>{
          hide($('#result-placeholder'));
          show(resultImg);
        };

        updateProgress(100, '–ì–æ—Ç–æ–≤–æ!');
        setStep(4);
      }catch(err){
        console.error(err);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–∏–∑–∞–π–Ω: ' + err.message);
        setStep(2);
      }
    });

    function updateProgress(pct, text){
      $('#progress-bar').style.width = pct + '%';
      $('#progress-text').textContent = text;
    }

    // ---------- —á–∞—Ç –∏ –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è ----------
    function addMessage(who, text){
      const c = $('#chat-container');
      const wrap = document.createElement('div');
      wrap.className = 'mb-3';
      const b = document.createElement('div');
      b.className = (who==='ai' ? 'bg-blue-100' : 'bg-gray-100') + ' rounded-lg p-3 inline-block';
      b.innerHTML = `<strong>${who==='ai'?'–ò–ò':'–í—ã'}:</strong> ${text}`;
      wrap.appendChild(b);
      c.appendChild(wrap);
      c.scrollTop = c.scrollHeight;
    }

    $('#send-message').addEventListener('click', ()=>{
      const val = $('#chat-input').value.trim();
      if(!val) return;
      lastFeedback = val;
      addMessage('user', val);
      $('#chat-input').value = '';
      setTimeout(()=> addMessage('ai','–ü—Ä–∏–Ω—è—Ç–æ! –ù–∞–∂–º–∏—Ç–µ ¬´–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å¬ª.'),
                 500);
    });

    async function regenerateDesign(){
      if(!uploadedFiles.length){
        alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ.');
        return;
      }
      if(!lastFeedback){
        alert('–°–Ω–∞—á–∞–ª–∞ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø—Ä–∞–≤–∫–∞–º–∏.');
        return;
      }
      const btn = $('#regenerate-design');
      btn.disabled = true;
      addMessage('ai','–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä—É—é —Å —É—á—ë—Ç–æ–º –ø—Ä–∞–≤–æ–∫‚Ä¶');
      hide($('#result-image'));
      show($('#result-placeholder'));
      try{
        const fd = new FormData();
        [...uploadedFiles, ...referenceFiles].forEach(f=> fd.append('image', f, f.name));
        fd.append('prompt', `${lastPrompt}. ${lastFeedback}`.trim());

        const res = await fetch('/api/redesign', { method:'POST', body: fd });
        if(!res.ok){
          const t = await res.text();
          throw new Error(`API –æ—à–∏–±–∫–∞ ${res.status}: ${t}`);
        }

        const data = await res.json();
        const imgSrc = data.image_base64
          ? `data:image/png;base64,${data.image_base64}`
          : data.image_url;

        const resultImg = $('#result-image');
        resultImg.src = imgSrc;
        resultImg.onload = ()=>{
          hide($('#result-placeholder'));
          show(resultImg);
        };
      }catch(err){
        console.error(err);
        addMessage('ai', '–û—à–∏–±–∫–∞: ' + err.message);
        hide($('#result-image'));
        $('#result-placeholder').textContent = '–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏';
      }finally{
        btn.disabled = false;
      }
    }

    $('#regenerate-design').addEventListener('click', regenerateDesign);

    $('#approve-design').addEventListener('click', ()=>{
      setStep(5);
      window.scrollTo({top:0,behavior:'smooth'});
    });

    setStep(1);
  </script>
</body>
</html>
