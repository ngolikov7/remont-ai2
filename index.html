<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–î–∏–∑–∞–π–Ω–ò–ò ‚Äî —Ä–µ–¥–∏–∑–∞–π–Ω –∫–æ–º–Ω–∞—Ç—ã</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='64' height='64'%3E%3Ctext y='56' font-size='56'%3E%F0%9F%8F%A0%3C/text%3E%3C/svg%3E" />
  <style>
    .step-dot{width:32px;height:32px}
    .hidden-el{display:none}
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <header class="w-full border-b bg-white/70 sticky top-0 backdrop-blur z-30">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center gap-3">
      <div class="text-2xl">üè†</div>
      <div>
        <div class="text-xl font-bold">–î–∏–∑–∞–π–Ω–ò–ò</div>
        <div class="text-sm text-gray-500">–£–º–Ω—ã–π —Ä–µ–º–æ–Ω—Ç —Å –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–º –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–æ–º</div>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 pb-24">
    <!-- Steps header -->
    <nav id="steps" class="grid grid-cols-6 gap-3 mt-6">
      <div class="flex items-center gap-2">
        <span class="step-dot rounded-full flex items-center justify-center bg-purple-600 text-white font-bold">1</span>
        <span class="font-medium">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ</span>
      </div>
      <div class="flex items-center gap-2 opacity-50" data-step="2">
        <span class="step-dot rounded-full flex items-center justify-center bg-gray-200 text-gray-600 font-bold">2</span>
        <span class="font-medium">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã</span>
      </div>
      <div class="flex items-center gap-2 opacity-50" data-step="3">
        <span class="step-dot rounded-full flex items-center justify-center bg-gray-200 text-gray-600 font-bold">3</span>
        <span class="font-medium">–ü–æ–∂–µ–ª–∞–Ω–∏—è</span>
      </div>
      <div class="flex items-center gap-2 opacity-50" data-step="4">
        <span class="step-dot rounded-full flex items-center justify-center bg-gray-200 text-gray-600 font-bold">4</span>
        <span class="font-medium">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è</span>
      </div>
      <div class="flex items-center gap-2 opacity-50" data-step="5">
        <span class="step-dot rounded-full flex items-center justify-center bg-gray-200 text-gray-600 font-bold">5</span>
        <span class="font-medium">–ü—Ä–∞–≤–∫–∏</span>
      </div>
      <div class="flex items-center gap-2 opacity-50" data-step="6">
        <span class="step-dot rounded-full flex items-center justify-center bg-gray-200 text-gray-600 font-bold">6</span>
        <span class="font-medium">–ü–ª–∞–Ω —Ä–µ–º–æ–Ω—Ç–∞</span>
      </div>
    </nav>

    <!-- progress line -->
    <div class="w-full h-2 bg-gray-200 rounded mt-3">
      <div id="progress" class="h-2 bg-purple-600 rounded transition-all" style="width: 16%"></div>
    </div>

    <!-- Step 1: Upload -->
    <section id="step1" class="mt-8 bg-white rounded-xl shadow p-6">
      <h2 class="text-2xl font-bold mb-2">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é –≤–∞—à–µ–π –∫–æ–º–Ω–∞—Ç—ã</h2>
      <p class="text-gray-600 mb-4">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è JPG/PNG/WEBP (–¥–æ 10 –ú–ë)</p>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="border-2 border-dashed rounded-xl min-h-[320px] flex flex-col items-center justify-center p-6 text-center">
          <input id="file" type="file" accept="image/*" class="hidden" />
          <button id="pickFile" class="px-4 py-2 rounded-lg bg-purple-600 text-white hover:bg-purple-700 transition">
            –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
          </button>
          <p id="fileName" class="mt-3 text-sm text-gray-500">–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω</p>
          <img id="preview" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä" class="hidden-el mt-4 max-h-64 rounded shadow" />
        </div>

        <div class="bg-gray-50 rounded-xl p-4 flex flex-col justify-between">
          <div>
            <h3 class="font-semibold mb-2">–ü–æ–¥—Å–∫–∞–∑–∫–∞</h3>
            <p class="text-sm text-gray-600">
              –î–ª—è –ª—É—á—à–µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ç–æ –ø—Ä–∏ –¥–Ω–µ–≤–Ω–æ–º –æ—Å–≤–µ—â–µ–Ω–∏–∏, –±–µ–∑ —Å–∏–ª—å–Ω—ã—Ö –ø–µ—Ä–µ—Å–≤–µ—Ç–æ–≤. –ü—Ä—è–º–æ–π —Ä–∞–∫—É—Ä—Å –Ω–∞ –∫–æ–º–Ω–∞—Ç—É ‚Äî —Å–∞–º–æ–µ —Ç–æ.
            </p>
          </div>
          <div class="mt-6 text-right">
            <button id="toStep2" disabled class="px-4 py-2 rounded-lg bg-gray-300 text-gray-600 cursor-not-allowed">
              –î–∞–ª–µ–µ ‚Üí –ü–∞—Ä–∞–º–µ—Ç—Ä—ã
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- Step 2: Parameters (–º–∏–Ω–∏–º—É–º –ø–æ–ª–µ–π, –º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä—è—Ç—å) -->
    <section id="step2" class="mt-8 bg-white rounded-xl shadow p-6 hidden-el">
      <h2 class="text-2xl font-bold mb-2">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã</h2>
      <p class="text-gray-600 mb-4">–í—ã–±–µ—Ä–∏—Ç–µ –±–∞–∑–æ–≤—ã–π —Å—Ç–∏–ª—å (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –ø–æ–∂–µ–ª–∞–Ω–∏—è –±—É–¥—É—Ç –≤–∞–∂–Ω–µ–µ).</p>

      <div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">
        <label class="flex items-center gap-2">
          <input type="radio" name="style" value="—Å–∫–∞–Ω–¥–∏" class="text-purple-600" />
          <span>–°–∫–∞–Ω–¥–∏–Ω–∞–≤—Å–∫–∏–π</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="radio" name="style" value="–º–∏–Ω–∏–º–∞–ª–∏–∑–º" class="text-purple-600" />
          <span>–ú–∏–Ω–∏–º–∞–ª–∏–∑–º</span>
        </label>
        <label class="flex items-center gap-2">
          <input type="radio" name="style" value="–ª–æ—Ñ—Ç" class="text-purple-600" />
          <span>–õ–æ—Ñ—Ç</span>
        </label>
      </div>

      <div class="mt-6 flex justify-between">
        <button class="px-4 py-2 rounded-lg border" data-back="1">‚Üê –ù–∞–∑–∞–¥</button>
        <button id="toStep3" class="px-4 py-2 rounded-lg bg-purple-600 text-white hover:bg-purple-700">
          –î–∞–ª–µ–µ ‚Üí –ü–æ–∂–µ–ª–∞–Ω–∏—è
        </button>
      </div>
    </section>

    <!-- Step 3: Wishes -->
    <section id="step3" class="mt-8 bg-white rounded-xl shadow p-6 hidden-el">
      <h2 class="text-2xl font-bold mb-2">–ü–æ–∂–µ–ª–∞–Ω–∏—è</h2>
      <p class="text-gray-600 mb-4">–û–ø–∏—à–∏—Ç–µ, —á–µ–≥–æ —Ö–æ—Ç–∏—Ç–µ –¥–æ–±–∏—Ç—å—Å—è (—Ü–≤–µ—Ç, —Å–≤–µ—Ç, –º–µ–±–µ–ª—å, –∞—Ç–º–æ—Å—Ñ–µ—Ä–∞, –±—é–¥–∂–µ—Ç –∏ —Ç.–ø.).</p>

      <textarea id="wishes" rows="4" class="w-full rounded-lg border p-3"
        placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —Å–≤–µ—Ç–ª—ã–π —Å–∫–∞–Ω–¥–∏, –±–æ–ª—å—à–µ –¥–Ω–µ–≤–Ω–æ–≥–æ —Å–≤–µ—Ç–∞, –∑–∞–º–µ–Ω–∏—Ç—å —à—Ç–æ—Ä—ã –∏ –∫–æ–≤–µ—Ä, —É–±—Ä–∞—Ç—å –≤–∏–∑—É–∞–ª—å–Ω—ã–π —à—É–º..."></textarea>

      <div class="mt-6 flex justify-between">
        <button class="px-4 py-2 rounded-lg border" data-back="2">‚Üê –ù–∞–∑–∞–¥</button>
        <button id="toStep4" class="px-4 py-2 rounded-lg bg-purple-600 text-white hover:bg-purple-700">
          –î–∞–ª–µ–µ ‚Üí –ì–µ–Ω–µ—Ä–∞—Ü–∏—è
        </button>
      </div>
    </section>

    <!-- Step 4: Generation -->
    <section id="step4" class="mt-8 bg-white rounded-xl shadow p-6 hidden-el">
      <h2 class="text-2xl font-bold mb-2">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è</h2>
      <p class="text-gray-600 mb-4">–ù–∞–∂–º–∏—Ç–µ ¬´–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å¬ª, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é —Å —É—á—ë—Ç–æ–º –ø–æ–∂–µ–ª–∞–Ω–∏–π.</p>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div>
          <h3 class="font-semibold mb-2">–ò—Å—Ö–æ–¥–Ω–æ–µ —Ñ–æ—Ç–æ</h3>
          <img id="sourceSmall" class="w-full max-h-[360px] object-contain rounded border" alt="–ò—Å—Ö–æ–¥–Ω–æ–µ"/>
        </div>
        <div>
          <h3 class="font-semibold mb-2">–ù–æ–≤—ã–π –¥–∏–∑–∞–π–Ω</h3>
          <div class="bg-gradient-to-br from-blue-100 to-purple-100 rounded-lg p-4 h-[360px] flex items-center justify-center">
            <img id="result" class="max-h-[320px] object-contain hidden-el rounded border bg-white" alt="–†–µ–∑—É–ª—å—Ç–∞—Ç"/>
            <span id="resultPh" class="text-gray-700 text-center">üé® –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å</span>
          </div>
        </div>
      </div>

      <div class="mt-6 flex items-center gap-3">
        <button class="px-4 py-2 rounded-lg border" data-back="3">‚Üê –ù–∞–∑–∞–¥</button>
        <button id="btnGen" class="px-4 py-2 rounded-lg bg-purple-600 text-white hover:bg-purple-700">
          –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å
        </button>

        <div id="genState" class="text-sm text-gray-600 hidden-el">
          <span class="animate-pulse">–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º‚Ä¶</span>
        </div>
      </div>

      <div id="alert" class="mt-4 hidden-el p-3 rounded bg-red-50 text-red-800 text-sm"></div>

      <div class="mt-6 flex justify-end">
        <button id="toStep5" disabled class="px-4 py-2 rounded-lg bg-gray-300 text-gray-600 cursor-not-allowed">
          –î–∞–ª–µ–µ ‚Üí –ü—Ä–∞–≤–∫–∏
        </button>
      </div>
    </section>

    <!-- Step 5: Edits (–±–æ–ª—Ç–∞–ª–∫–∞-–∑–∞–≥–ª—É—à–∫–∞) -->
    <section id="step5" class="mt-8 bg-white rounded-xl shadow p-6 hidden-el">
      <h2 class="text-2xl font-bold mb-2">–ü—Ä–∞–≤–∫–∏</h2>
      <p class="text-gray-600">–ù–∞–ø–∏—à–∏—Ç–µ, —á—Ç–æ –±—ã –≤—ã —Ö–æ—Ç–µ–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å ‚Äî –º—ã –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤–∞—Ä–∏–∞–Ω—Ç.</p>

      <div class="grid gap-4 grid-cols-1 lg:grid-cols-2">
        <img id="resultCopy" class="rounded border bg-white max-h-[360px] object-contain" alt="" />
        <div class="flex flex-col">
          <textarea id="edits" rows="5" class="w-full rounded-lg border p-3"
            placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —Å–¥–µ–ª–∞—Ç—å —Å—Ç–µ–Ω—ã —á—É—Ç—å —Å–≤–µ—Ç–ª–µ–µ, –∑–∞–º–µ–Ω–∏—Ç—å –∫–æ–≤–µ—Ä –Ω–∞ –æ–¥–Ω–æ—Ç–æ–Ω–Ω—ã–π, –¥–æ–±–∞–≤–∏—Ç—å —Ç–µ–ø–ª—ã–π —Ç–æ—Ä—à–µ—Ä‚Ä¶"></textarea>
          <div class="mt-4">
            <button id="btnRegen" class="px-4 py-2 rounded-lg bg-purple-600 text-white hover:bg-purple-700">
              –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å –ø—Ä–∞–≤–∫–∞–º–∏
            </button>
          </div>
          <div id="editState" class="text-sm text-gray-600 mt-3 hidden-el">
            <span class="animate-pulse">–î–µ–ª–∞–µ–º –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é‚Ä¶</span>
          </div>
        </div>
      </div>

      <div id="alert2" class="mt-4 hidden-el p-3 rounded bg-red-50 text-red-800 text-sm"></div>

      <div class="mt-6 flex justify-end">
        <button id="toStep6" class="px-4 py-2 rounded-lg bg-purple-600 text-white hover:bg-purple-700">
          –î–∞–ª–µ–µ ‚Üí –ü–ª–∞–Ω —Ä–µ–º–æ–Ω—Ç–∞
        </button>
      </div>
    </section>

    <!-- Step 6: Plan -->
    <section id="step6" class="mt-8 bg-white rounded-xl shadow p-6 hidden-el">
      <h2 class="text-2xl font-bold mb-2">–ü–ª–∞–Ω —Ä–µ–º–æ–Ω—Ç–∞</h2>
      <p class="text-gray-600 mb-4">–°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ—Å–ª–µ–¥–Ω–µ–π –≤–µ—Ä—Å–∏–∏ –¥–∏–∑–∞–π–Ω–∞ (—á–µ—Ä–Ω–æ–≤–∏–∫).</p>

      <ol class="list-decimal pl-6 space-y-2 text-sm">
        <li>–ü–æ–¥–±–æ—Ä –∫—Ä–∞—Å–∫–∏ / –æ—Ç–¥–µ–ª–∫–∏ —Å—Ç–µ–Ω.</li>
        <li>–°–º–µ–Ω–∞ –æ—Å–≤–µ—â–µ–Ω–∏—è (–æ—Å–Ω–æ–≤–Ω–æ–π —Å–≤–µ—Ç + —Ç–æ—Ä—à–µ—Ä/–±—Ä–∞).</li>
        <li>–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∏–ª—è: —à—Ç–æ—Ä—ã, –∫–æ–≤–µ—Ä, –ø–æ–¥—É—à–∫–∏.</li>
        <li>–†–∞—Å—Å–∞–¥–∫–∞ –º–µ–±–µ–ª–∏ —Å —É—á–µ—Ç–æ–º –ø—Ä–æ—Ö–æ–¥–æ–≤ –∏ —Å–≤–µ—Ç–∞.</li>
        <li>–î–µ–∫–æ—Ä: —Ä–∞—Å—Ç–µ–Ω–∏—è, –ø–æ—Å—Ç–µ—Ä—ã, –º–µ–ª–æ—á–∏.</li>
      </ol>

      <div class="mt-6 flex justify-between">
        <button class="px-4 py-2 rounded-lg border" data-back="5">‚Üê –ù–∞–∑–∞–¥</button>
        <a href="/" class="px-4 py-2 rounded-lg bg-purple-600 text-white hover:bg-purple-700">–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</a>
      </div>
    </section>
  </main>

  <script>
    // --- state ---
    let uploadedFile = null;

    // --- helpers ---
    const qs  = (s,root=document)=>root.querySelector(s);
    const qsa = (s,root=document)=>[...root.querySelectorAll(s)];
    const show = el => el.classList.remove('hidden-el');
    const hide = el => el.classList.add('hidden-el');

    const setStepActive = (n) => {
      // progress bar
      const pct = Math.max(1, Math.min(6,n)) / 6 * 100;
      qs('#progress').style.width = pct + '%';

      // header dots
      qsa('#steps > div').forEach((wrap, idx)=>{
        const dot = qs('.step-dot', wrap);
        const label = wrap.lastElementChild;
        if(idx < n) {
          wrap.classList.remove('opacity-50');
          dot.classList.remove('bg-gray-200','text-gray-600');
          dot.classList.add('bg-purple-600','text-white');
          label.classList.add('font-medium');
        } else {
          wrap.classList.add('opacity-50');
          dot.classList.add('bg-gray-200','text-gray-600');
          dot.classList.remove('bg-purple-600','text-white');
        }
      });

      // sections
      for(let i=1;i<=6;i++){
        const sec = qs('#step'+i);
        if(i===n) show(sec); else hide(sec);
      }
    };

    const enableButton = (btn, on=true) => {
      btn.disabled = !on;
      if(on){
        btn.classList.remove('bg-gray-300','text-gray-600','cursor-not-allowed');
        btn.classList.add('bg-purple-600','text-white','hover:bg-purple-700');
      } else {
        btn.classList.add('bg-gray-300','text-gray-600','cursor-not-allowed');
        btn.classList.remove('bg-purple-600','text-white','hover:bg-purple-700');
      }
    };

    // --- elements ---
    const pickFile = qs('#pickFile');
    const fileInput = qs('#file');
    const fileName  = qs('#fileName');
    const preview   = qs('#preview');
    const sourceSmall = qs('#sourceSmall');

    const toStep2 = qs('#toStep2');
    const toStep3 = qs('#toStep3');
    const toStep4 = qs('#toStep4');
    const toStep5 = qs('#toStep5');
    const toStep6 = qs('#toStep6');

    const wishes   = qs('#wishes');
    const btnGen   = qs('#btnGen');
    const btnRegen = qs('#btnRegen');
    const genState = qs('#genState');
    const editState= qs('#editState');
    const alert1   = qs('#alert');
    const alert2   = qs('#alert2');

    const resultImg = qs('#result');
    const resultPh  = qs('#resultPh');
    const resultCopy= qs('#resultCopy');

    // --- step 1: pick file ---
    pickFile.addEventListener('click', ()=> fileInput.click());
    fileInput.addEventListener('change', ()=>{
      const f = fileInput.files?.[0];
      if(!f){ return; }
      uploadedFile = f;
      fileName.textContent = f.name;

      const url = URL.createObjectURL(f);
      preview.src = url;
      preview.onload = ()=> URL.revokeObjectURL(url);
      show(preview);

      enableButton(toStep2,true);
    });

    // go to step 2
    toStep2.addEventListener('click', ()=>{
      setStepActive(2);
    });

    // back buttons
    qsa('[data-back]').forEach(b=>{
      b.addEventListener('click', e=>{
        const backTo = Number(e.currentTarget.getAttribute('data-back'));
        setStepActive(backTo);
      });
    });

    toStep3.addEventListener('click', ()=> setStepActive(3));
    toStep4.addEventListener('click', ()=>{
      // –ø–µ—Ä–µ–Ω–µ—Å—ë–º –ø—Ä–µ–≤—å—é –≤ –±–ª–æ–∫ "–ò—Å—Ö–æ–¥–Ω–æ–µ —Ñ–æ—Ç–æ"
      if(uploadedFile){
        const url = URL.createObjectURL(uploadedFile);
        sourceSmall.src = url;
        sourceSmall.onload = ()=> URL.revokeObjectURL(url);
      }
      setStepActive(4);
    });

    // --- send form to /api/redesign ---
    const sendToApi = async (extraPrompt="")=>{
      const fd = new FormData();
      fd.append('image', uploadedFile, uploadedFile?.name || 'photo.jpg');

      // –°–æ–±–∏—Ä–∞–µ–º —Å—Ç–∏–ª–µ–≤–æ–µ —Ä–∞–¥–∏–æ, –ø–æ–∂–µ–ª–∞–Ω–∏—è –∏ –ø—Ä–∞–≤–∫–∏
      const picked = qs('input[name="style"]:checked');
      const style = picked ? picked.value : '';
      const txt = [ style, wishes.value || '', extraPrompt || '' ]
        .filter(Boolean)
        .join('. ')
        .trim();

      fd.append('prompt', txt || '–°–¥–µ–ª–∞–π —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—É—é, —Å–≤–µ—Ç–ª—É—é –∏ —É—é—Ç–Ω—É—é –∫–æ–º–Ω–∞—Ç—É, –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–µ —Ü–≤–µ—Ç–∞, —á–∏—Å—Ç–∞—è –∫–æ–º–ø–æ–∑–∏—Ü–∏—è.');

      const res = await fetch('/api/redesign', { method:'POST', body: fd });
      let payloadText = null;
      try{ payloadText = await res.text(); }catch(_){}
      if(!res.ok){
        const msg = payloadText || `–û—à–∏–±–∫–∞ ${res.status}`;
        throw new Error(msg);
      }
      // –æ–∂–∏–¥–∞–µ–º –æ—Ç–≤–µ—Ç —Å base64 (data:image/‚Ä¶)
      const data = JSON.parse(payloadText);
      if(!data || !data.ok) throw new Error(data?.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
      return data.url; // –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—ë—Ç url data:image/png;base64,‚Ä¶
    };

    const showResult = (url)=>{
      resultImg.src = url;
      resultCopy.src = url;
      hide(resultPh);
      show(resultImg);
      enableButton(toStep5,true);
    };

    // generate
    btnGen.addEventListener('click', async ()=>{
      // guards
      if(!uploadedFile){
        alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ –Ω–∞ —à–∞–≥–µ 1.');
        return;
      }
      hide(alert1); show(genState);
      enableButton(btnGen,false);

      try{
        const url = await sendToApi();
        showResult(url);
      }catch(err){
        // —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ —á–∞—Å—Ç—ã–º —Å–ª—É—á–∞—è–º
        let m = String(err.message || err);
        if(m.includes('403') || m.toLowerCase().includes('policy') || m.toLowerCase().includes('verify')){
          m = '–î–æ—Å—Ç—É–ø –∫ –º–æ–¥–µ–ª–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω (403). –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤–∞—à OpenAI-–∞–∫–∫–∞—É–Ω—Ç –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω –∏ –∫–ª—é—á –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –Ω—É–∂–Ω–æ–π –º–æ–¥–µ–ª–∏.';
        }
        alert1.textContent = m;
        show(alert1);
      }finally{
        hide(genState);
        enableButton(btnGen,true);
      }
    });

    // go step 5 if ok
    toStep5.addEventListener('click', ()=> setStepActive(5));

    // re-generate with edits
    btnRegen.addEventListener('click', async ()=>{
      const extra = qs('#edits').value.trim();
      hide(alert2); show(editState);
      enableButton(btnRegen,false);
      try{
        const url = await sendToApi(extra);
        showResult(url);
        // –æ–±–Ω–æ–≤–∏–º –∫–æ–ø–∏—é
        resultCopy.src = url;
      }catch(err){
        let m = String(err.message || err);
        if(m.includes('403')) m = '–î–æ—Å—Ç—É–ø –∫ –º–æ–¥–µ–ª–∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω (403). –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é –∏ –ø—Ä–∞–≤–∞ –∫–ª—é—á–∞.';
        alert2.textContent = m;
        show(alert2);
      }finally{
        hide(editState);
        enableButton(btnRegen,true);
      }
    });

    // step 6 from 5
    toStep6.addEventListener('click', ()=> setStepActive(6));

    // —Å—Ç–∞—Ä—Ç
    setStepActive(1);
  </script>
</body>
</html>
