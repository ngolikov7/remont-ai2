<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–î–∏–∑–∞–π–Ω–ò–ò ‚Äî —É–º–Ω—ã–π —Ä–µ–º–æ–Ω—Ç</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .step-dot{width:32px;height:32px}
    .hidden-el{display:none}
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <!-- Header -->
  <header class="w-full border-b bg-white/70 sticky top-0 backdrop-blur z-30">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
      <div class="text-2xl">üè†</div>
      <div class="text-xl font-bold">–î–∏–∑–∞–π–Ω–ò–ò</div>
      <div class="text-sm text-gray-500">–£–º–Ω—ã–π —Ä–µ–º–æ–Ω—Ç —Å –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–º –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–æ–º</div>
    </div>
  </header>

  <!-- Steps bar -->
  <div class="max-w-7xl mx-auto px-4 py-4">
    <div class="flex items-center justify-between bg-white rounded-xl shadow px-4 py-3">
      <div class="flex items-center gap-2">
        <div id="s1" class="step-dot rounded-full flex items-center justify-center font-semibold bg-violet-600 text-white">1</div>
        <span class="text-sm font-medium">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–æ—Ç–æ</span>
      </div>
      <div class="text-gray-300">‚Äî</div>
      <div class="flex items-center gap-2">
        <div id="s2" class="step-dot rounded-full flex items-center justify-center font-semibold bg-gray-200">2</div>
        <span class="text-sm font-medium">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã</span>
      </div>
      <div class="text-gray-300">‚Äî</div>
      <div class="flex items-center gap-2">
        <div id="s3" class="step-dot rounded-full flex items-center justify-center font-semibold bg-gray-200">3</div>
        <span class="text-sm font-medium">–ü–æ–∂–µ–ª–∞–Ω–∏—è</span>
      </div>
      <div class="text-gray-300">‚Äî</div>
      <div class="flex items-center gap-2">
        <div id="s4" class="step-dot rounded-full flex items-center justify-center font-semibold bg-gray-200">4</div>
        <span class="text-sm font-medium">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è</span>
      </div>
      <div class="text-gray-300">‚Äî</div>
      <div class="flex items-center gap-2">
        <div id="s5" class="step-dot rounded-full flex items-center justify-center font-semibold bg-gray-200">5</div>
        <span class="text-sm font-medium">–ü—Ä–∞–≤–∫–∏</span>
      </div>
      <div class="text-gray-300">‚Äî</div>
      <div class="flex items-center gap-2">
        <div id="s6" class="step-dot rounded-full flex items-center justify-center font-semibold bg-gray-200">6</div>
        <span class="text-sm font-medium">–ü–ª–∞–Ω —Ä–µ–º–æ–Ω—Ç–∞</span>
      </div>
    </div>
  </div>

  <main class="max-w-7xl mx-auto px-4 pb-16">
    <!-- STEP 1: –ó–∞–≥—Ä—É–∑–∫–∞ -->
    <section id="step-1" class="bg-white rounded-xl shadow p-6">
      <h2 class="text-xl font-bold mb-4">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é –≤–∞—à–µ–π –∫–æ–º–Ω–∞—Ç—ã</h2>
      <div id="drop-area"
           class="border-2 border-dashed border-gray-300 rounded-2xl p-10 text-center hover:border-violet-400 transition">
        <div class="text-6xl mb-2">üì∑</div>
        <p class="text-lg font-medium">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–æ—Ç–æ —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</p>
        <p class="text-sm text-gray-500">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è JPG/PNG/WEBP (–¥–æ 10 –ú–ë)</p>
        <input id="file-input" type="file" accept="image/*" class="hidden" />
        <button id="pick-file"
                class="mt-4 inline-flex items-center rounded-lg bg-violet-600 px-4 py-2 text-white hover:bg-violet-700">
          –í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª
        </button>
      </div>

      <div id="upload-preview"
           class="hidden mt-6 bg-gray-100 rounded-xl h-[360px] flex items-center justify-center overflow-hidden">
        <img id="preview-img" class="max-h-full max-w-full object-contain" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä"/>
      </div>

      <div class="mt-6 flex justify-between">
        <div></div>
        <button id="to-2"
                class="inline-flex items-center rounded-lg bg-violet-600 px-4 py-2 text-white hover:bg-violet-700 disabled:opacity-50"
                disabled>
          –î–∞–ª–µ–µ
        </button>
      </div>
    </section>

    <!-- STEP 2: –ü–∞—Ä–∞–º–µ—Ç—Ä—ã -->
    <section id="step-2" class="bg-white rounded-xl shadow p-6 hidden-el">
      <h2 class="text-xl font-bold mb-4">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–∏–∑–∞–π–Ω–∞</h2>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="text-sm font-medium">–°—Ç–∏–ª—å</label>
          <select id="style" class="mt-1 w-full rounded-lg border px-3 py-2 text-sm">
            <option value="">–õ—é–±–æ–π / –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é</option>
            <option>–°–∫–∞–Ω–¥–∏–Ω–∞–≤—Å–∫–∏–π</option>
            <option>–ú–∏–Ω–∏–º–∞–ª–∏–∑–º</option>
            <option>–õ–æ—Ñ—Ç</option>
            <option>–ö–ª–∞—Å—Å–∏–∫–∞</option>
            <option>–°–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π</option>
          </select>
        </div>
        <div>
          <label class="text-sm font-medium">–ü–∞–ª–∏—Ç—Ä–∞</label>
          <select id="palette" class="mt-1 w-full rounded-lg border px-3 py-2 text-sm">
            <option value="">–ù–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è</option>
            <option>–°–≤–µ—Ç–ª–∞—è</option>
            <option>–¢—ë–ø–ª–∞—è</option>
            <option>–•–æ–ª–æ–¥–Ω–∞—è</option>
            <option>–ö–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–∞—è</option>
          </select>
        </div>
      </div>

      <div class="mt-6 flex justify-between">
        <button id="back-1" class="rounded-lg border px-4 py-2">–ù–∞–∑–∞–¥</button>
        <button id="to-3" class="inline-flex items-center rounded-lg bg-violet-600 px-4 py-2 text-white hover:bg-violet-700">
          –î–∞–ª–µ–µ
        </button>
      </div>
    </section>

    <!-- STEP 3: –ü–æ–∂–µ–ª–∞–Ω–∏—è -->
    <section id="step-3" class="bg-white rounded-xl shadow p-6 hidden-el">
      <h2 class="text-xl font-bold mb-4">–ü–æ–∂–µ–ª–∞–Ω–∏—è</h2>

      <label class="text-sm font-medium">–ß—Ç–æ –≤–∞–∂–Ω–æ —É—á–µ—Å—Ç—å?</label>
      <textarea id="wishes" rows="5"
                class="mt-1 w-full rounded-lg border px-3 py-2 text-sm"
                placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —Å–≤–µ—Ç–ª—ã–π —Å–∫–∞–Ω–¥–∏ —Å –¥–µ—Ä–µ–≤—è–Ω–Ω–æ–π –º–µ–±–µ–ª—å—é, –¥–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ –¥–Ω–µ–≤–Ω–æ–≥–æ —Å–≤–µ—Ç–∞‚Ä¶"></textarea>

      <div class="mt-6 flex justify-between">
        <button id="back-2" class="rounded-lg border px-4 py-2">–ù–∞–∑–∞–¥</button>
        <button id="to-4" class="inline-flex items-center rounded-lg bg-violet-600 px-4 py-2 text-white hover:bg-violet-700">
          –î–∞–ª–µ–µ
        </button>
      </div>
    </section>

    <!-- STEP 4: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è -->
    <section id="step-4" class="bg-white rounded-xl shadow p-6 hidden-el">
      <h2 class="text-xl font-bold mb-4">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è</h2>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div>
          <div class="text-lg font-semibold mb-3">–ò—Å—Ö–æ–¥–Ω–æ–µ —Ñ–æ—Ç–æ</div>
          <div class="bg-gray-100 rounded-lg h-[400px] flex items-center justify-center overflow-hidden">
            <img id="final-origin" class="max-h-full max-w-full object-contain" alt="–ò—Å—Ö–æ–¥–Ω–æ–µ"/>
          </div>
        </div>

        <div>
          <div class="text-lg font-semibold mb-3">–ù–æ–≤—ã–π –¥–∏–∑–∞–π–Ω</div>
          <div class="bg-gradient-to-br from-blue-100 to-purple-100 rounded-lg h-[400px] flex items-center justify-center overflow-hidden">
            <img id="result-image" class="max-h-full max-w-full object-contain hidden" alt="–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–∏–∑–∞–π–Ω"/>
            <span id="result-placeholder" class="text-gray-700">üé® –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å</span>
          </div>
        </div>
      </div>

      <div id="gen-error" class="mt-4 text-sm text-red-600 hidden"></div>
      <div id="gen-status" class="mt-2 text-sm text-gray-500"></div>

      <div class="mt-6 flex justify-between">
        <button id="back-3" class="rounded-lg border px-4 py-2">–ù–∞–∑–∞–¥</button>
        <button id="start-generation"
                class="inline-flex items-center rounded-lg bg-violet-600 px-4 py-2 text-white hover:bg-violet-700 disabled:opacity-50">
          üöÄ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å
        </button>
      </div>
    </section>

    <!-- STEP 5: –ü—Ä–∞–≤–∫–∏ -->
    <section id="step-5" class="bg-white rounded-xl shadow p-6 hidden-el">
      <h2 class="text-xl font-bold mb-4">–ü—Ä–∞–≤–∫–∏</h2>

      <div class="mb-4 text-sm text-gray-500">
        –ù–∞–ø–∏—à–∏—Ç–µ, —á—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—å, –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å¬ª.
      </div>

      <textarea id="rev-text" rows="4"
                class="w-full rounded-lg border px-3 py-2 text-sm"
                placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —Å–¥–µ–ª–∞–π—Ç–µ —Å—Ç–µ–Ω—ã —Å–≤–µ—Ç–ª–µ–µ, –¥–æ–±–∞–≤—å—Ç–µ –±–æ–ª—å—à–µ –¥–µ—Ä–µ–≤–∞..."></textarea>

      <div id="rev-status" class="mt-3 text-sm text-gray-500"></div>
      <div id="rev-error" class="mt-2 text-sm text-red-600 hidden"></div>

      <div class="mt-6 flex flex-wrap gap-3 justify-between">
        <div class="flex gap-3">
          <button id="regenerate-design"
                  class="rounded-lg border px-4 py-2 hover:bg-gray-50">
            –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å —É—á—ë—Ç–æ–º –ø—Ä–∞–≤–æ–∫
          </button>
          <button id="approve-design"
                  class="rounded-lg bg-emerald-600 px-4 py-2 text-white hover:bg-emerald-700">
            –£—Ç–≤–µ—Ä–¥–∏—Ç—å –∏ –ø–µ—Ä–µ–π—Ç–∏ –∫ –ø–ª–∞–Ω—É
          </button>
        </div>
        <button id="back-4" class="rounded-lg border px-4 py-2">–ù–∞–∑–∞–¥</button>
      </div>
    </section>

    <!-- STEP 6: –ü–ª–∞–Ω -->
    <section id="step-6" class="bg-white rounded-xl shadow p-6 hidden-el">
      <h2 class="text-xl font-bold mb-4">–ü–ª–∞–Ω —Ä–µ–º–æ–Ω—Ç–∞</h2>
      <div class="text-gray-700">
        –ó–¥–µ—Å—å –±—É–¥–µ—Ç —á–µ–∫-–ª–∏—Å—Ç –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤, —Å—Å—ã–ª–∫–∏ –Ω–∞ —Ç–æ–≤–∞—Ä—ã –∏ –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω—ã–π –±—é–¥–∂–µ—Ç (–∑–∞–≥–ª—É—à–∫–∞).
      </div>
      <div class="mt-6">
        <button id="back-5" class="rounded-lg border px-4 py-2">–ù–∞–∑–∞–¥</button>
      </div>
    </section>
  </main>

  <script>
    // ======= –ú–ê–°–¢–ï–† –®–ê–ì–û–í =======
    const sections = [
      document.getElementById('step-1'),
      document.getElementById('step-2'),
      document.getElementById('step-3'),
      document.getElementById('step-4'),
      document.getElementById('step-5'),
      document.getElementById('step-6')
    ];
    const dots = [ 's1','s2','s3','s4','s5','s6' ].map(id => document.getElementById(id));
    let currentStep = 1;
    function setStep(n){
      currentStep = n;
      sections.forEach((el, i)=>{
        if(i===n-1){ el.classList.remove('hidden-el'); }
        else { el.classList.add('hidden-el'); }
      });
      dots.forEach((d,i)=>{
        d.classList.toggle('bg-violet-600', i < n);
        d.classList.toggle('text-white', i < n);
        d.classList.toggle('bg-gray-200', i >= n);
      });
      window.scrollTo({top:0,behavior:'smooth'});
    }
    setStep(1);

    // ======= –®–ê–ì 1: –∑–∞–≥—Ä—É–∑–∫–∞ –∏ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä =======
    const dropArea = document.getElementById('drop-area');
    const pickFileBtn = document.getElementById('pick-file');
    const fileInput = document.getElementById('file-input');
    const previewWrap = document.getElementById('upload-preview');
    const previewImg  = document.getElementById('preview-img');
    const to2Btn = document.getElementById('to-2');

    let uploadedFile = null;

    ;['dragenter','dragover','dragleave','drop'].forEach(eventName=>{
      dropArea.addEventListener(eventName, e => { e.preventDefault(); e.stopPropagation(); });
    });
    dropArea.addEventListener('dragover', ()=>{
      dropArea.classList.add('ring-2','ring-violet-300');
    });
    dropArea.addEventListener('dragleave', ()=>{
      dropArea.classList.remove('ring-2','ring-violet-300');
    });
    dropArea.addEventListener('drop', e=>{
      dropArea.classList.remove('ring-2','ring-violet-300');
      const f = e.dataTransfer.files?.[0];
      if (f) setFile(f);
    });

    pickFileBtn.addEventListener('click', ()=> fileInput.click());
    fileInput.addEventListener('change', ()=>{
      const f = fileInput.files?.[0];
      if (f) setFile(f);
    });

    function setFile(f){
      uploadedFile = f;
      previewImg.src = URL.createObjectURL(f);
      previewWrap.classList.remove('hidden');
      document.getElementById('final-origin').src = previewImg.src; // –¥–ª—è —à–∞–≥–∞ 4
      to2Btn.disabled = false;
    }

    // ======= –ü–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É —à–∞–≥–∞–º–∏ 1‚Äì3 =======
    document.getElementById('to-2').onclick = ()=> setStep(2);
    document.getElementById('back-1').onclick = ()=> setStep(1);
    document.getElementById('to-3').onclick = ()=> setStep(3);
    document.getElementById('back-2').onclick = ()=> setStep(2);
    document.getElementById('to-4').onclick = ()=> setStep(4);

    // ======= –®–ê–ì 4: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è =======
    const startBtn = document.getElementById('start-generation');
    const genStatus = document.getElementById('gen-status');
    const genError  = document.getElementById('gen-error');
    const resultImg = document.getElementById('result-image');
    const resultPh  = document.getElementById('result-placeholder');

    function buildPrompt(){
      const parts = [];
      const style = document.getElementById('style').value;
      const palette = document.getElementById('palette').value;
      const wishes = (document.getElementById('wishes').value || '').trim();

      if(style) parts.push(`–°—Ç–∏–ª—å: ${style}.`);
      if(palette) parts.push(`–ü–∞–ª–∏—Ç—Ä–∞: ${palette}.`);
      if(wishes) parts.push(`–ü–æ–∂–µ–ª–∞–Ω–∏—è: ${wishes}.`);
      return parts.join(' ');
    }

    startBtn.addEventListener('click', async ()=>{
      if(!uploadedFile){
        setStep(1);
        return;
      }
      genError.classList.add('hidden');
      genError.textContent = '';
      genStatus.textContent = '–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å‚Ä¶';
      startBtn.disabled = true;
      resultImg.classList.add('hidden');
      resultPh.classList.remove('hidden');

      try{
        const fd = new FormData();
        fd.append('image', uploadedFile, uploadedFile.name); // –≤–∞–∂–Ω–æ: –∏–º—è –ø–æ–ª—è "image"
        fd.append('prompt', buildPrompt());

        const res = await fetch('/api/redesign', { method:'POST', body: fd });
        const data = await res.json().catch(()=>({ok:false,error:'bad json'}));

        if(!res.ok || !data?.ok){
          throw new Error(data?.details || data?.error || `API ${res.status}`);
        }

        resultImg.src = data.url;
        resultImg.onload = ()=>{
          resultPh.classList.add('hidden');
          resultImg.classList.remove('hidden');
        };
        genStatus.textContent = '–ì–æ—Ç–æ–≤–æ!';
      }catch(err){
        genError.textContent = String(err.message || err);
        genError.classList.remove('hidden');
        genStatus.textContent = '';
      }finally{
        startBtn.disabled = false;
      }
    });

    // ======= –®–ê–ì 5: –ø—Ä–æ—Å—Ç—ã–µ –ø—Ä–∞–≤–∫–∏ (–∑–∞–≥–ª—É—à–∫–∞ –ø–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏–∏) =======
    document.getElementById('back-3').onclick = ()=> setStep(3);
    document.getElementById('back-4').onclick = ()=> setStep(4);

    document.getElementById('regenerate-design').onclick = async ()=>{
      // –¥–µ–ª–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—ã–∑–æ–≤ —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º —Ä–µ–≤–∏–∑–∏–π –∫ –ø—Ä–æ–º–ø—Ç—É
      const rev = (document.getElementById('rev-text').value || '').trim();
      const add = rev ? ` –î–æ–ø. –ø—Ä–∞–≤–∫–∏: ${rev}` : '';
      document.getElementById('rev-status').textContent = '–ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è‚Ä¶';

      try{
        const fd = new FormData();
        fd.append('image', uploadedFile, uploadedFile.name);
        fd.append('prompt', buildPrompt() + add);

        const res = await fetch('/api/redesign', { method:'POST', body: fd });
        const data = await res.json().catch(()=>({ok:false}));
        if(!res.ok || !data?.ok) throw new Error(data?.details || data?.error || `API ${res.status}`);

        resultImg.src = data.url;
        resultImg.onload = ()=>{
          resultPh.classList.add('hidden');
          resultImg.classList.remove('hidden');
        };
        document.getElementById('rev-status').textContent = '–ì–æ—Ç–æ–≤–æ!';
        document.getElementById('rev-error').classList.add('hidden');
      } catch(e){
        document.getElementById('rev-error').textContent = String(e.message || e);
        document.getElementById('rev-error').classList.remove('hidden');
        document.getElementById('rev-status').textContent = '';
      }
    };

    document.getElementById('approve-design').onclick = ()=> setStep(6);
    document.getElementById('back-5').onclick = ()=> setStep(5);
  </script>
</body>
</html>
