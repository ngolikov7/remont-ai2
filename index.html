<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–î–∏–∑–∞–π–Ω–ò–ò ‚Äî —Ä–µ–¥–∏–∑–∞–π–Ω –∫–æ–º–Ω–∞—Ç—ã</title>
  <!-- Tailwind CDN –¥–ª—è —Å—Ç–∏–ª–µ–π -->
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-900">
  <header class="w-full border-b bg-white/70 sticky top-0 backdrop-blur z-30">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center gap-3">
      <div class="text-xl font-bold">üè† –î–∏–∑–∞–π–Ω–ò–ò</div>
      <div class="text-sm text-gray-500">–£–º–Ω—ã–π —Ä–µ–º–æ–Ω—Ç —Å –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–º –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–æ–º</div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-8">
    <h1 class="text-2xl font-bold mb-6">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è</h1>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- –õ–ï–í–ê–Ø –ö–û–õ–û–ù–ö–ê -->
      <section class="bg-white rounded-xl shadow p-4">
        <h2 class="text-lg font-semibold mb-3">–ò—Å—Ö–æ–¥–Ω–æ–µ —Ñ–æ—Ç–æ</h2>

        <div class="mb-3">
          <input id="file" type="file" accept="image/*"
                 class="block w-full text-sm file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0
                        file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700
                        hover:file:bg-violet-100"/>
        </div>

        <div id="preview-wrap"
             class="bg-gray-100 rounded-lg h-[420px] flex items-center justify-center overflow-hidden">
          <span class="text-gray-500 text-sm">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</span>
        </div>

        <div class="mt-4">
          <label class="text-sm font-medium">–ü–æ–∂–µ–ª–∞–Ω–∏—è</label>
          <textarea id="prompt" rows="4"
                    placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —Å–≤–µ—Ç–ª—ã–π —Å–∫–∞–Ω–¥–∏ —Å –¥–µ—Ä–µ–≤—è–Ω–Ω–æ–π –º–µ–±–µ–ª—å—é, –±–æ–ª—å—à–µ –¥–Ω–µ–≤–Ω–æ–≥–æ —Å–≤–µ—Ç–∞‚Ä¶"
                    class="mt-1 w-full rounded-lg border px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-violet-400"></textarea>
        </div>

        <div class="mt-4 flex gap-3">
          <button id="start"
                  class="inline-flex items-center gap-2 rounded-lg bg-violet-600 px-4 py-2 text-white
                         hover:bg-violet-700 disabled:opacity-50 disabled:cursor-not-allowed">
            üöÄ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å
          </button>
          <div id="status" class="text-sm text-gray-500"></div>
        </div>

        <div id="error" class="mt-3 text-sm text-red-600 hidden"></div>
      </section>

      <!-- –ü–†–ê–í–ê–Ø –ö–û–õ–û–ù–ö–ê -->
      <section class="bg-white rounded-xl shadow p-4">
        <h2 class="text-lg font-semibold mb-3">–ù–æ–≤—ã–π –¥–∏–∑–∞–π–Ω</h2>
        <div id="result-wrap"
             class="bg-gradient-to-br from-blue-100 to-purple-100 rounded-lg h-[520px]
                    flex items-center justify-center overflow-hidden">
          <span id="placeholder" class="text-gray-700">üé® –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å</span>
          <img id="result" class="max-h-full max-w-full object-contain hidden" alt="–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–∏–∑–∞–π–Ω"/>
        </div>
      </section>
    </div>
  </main>

  <script>
    const fileInput   = document.getElementById('file');
    const previewWrap = document.getElementById('preview-wrap');
    const promptEl    = document.getElementById('prompt');
    const startBtn    = document.getElementById('start');
    const resultImg   = document.getElementById('result');
    const placeholder = document.getElementById('placeholder');
    const statusEl    = document.getElementById('status');
    const errorEl     = document.getElementById('error');

    let uploadedFile = null;

    // –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
    fileInput.addEventListener('change', () => {
      const f = fileInput.files?.[0];
      uploadedFile = f || null;
      previewWrap.innerHTML = '';
      if (!f) {
        const span = document.createElement('span');
        span.className = 'text-gray-500 text-sm';
        span.textContent = '–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è';
        previewWrap.appendChild(span);
        return;
      }
      const img = document.createElement('img');
      img.src = URL.createObjectURL(f);
      img.className = 'max-h-full max-w-full object-contain';
      previewWrap.appendChild(img);
    });

    startBtn.addEventListener('click', async () => {
      errorEl.classList.add('hidden');
      errorEl.textContent = '';
      resultImg.classList.add('hidden');
      placeholder.classList.remove('hidden');
      statusEl.textContent = '–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä‚Ä¶';

      if (!uploadedFile) {
        errorEl.textContent = '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ.';
        errorEl.classList.remove('hidden');
        statusEl.textContent = '';
        return;
      }

      try {
        startBtn.disabled = true;

        const fd = new FormData();
        fd.append('image', uploadedFile, uploadedFile.name);
        fd.append('prompt', (promptEl.value || '').trim());

        const res = await fetch('/api/redesign', { method: 'POST', body: fd });
        let data;
        try { data = await res.json(); } catch (e) { data = { ok:false, error:'–ù–µ–≤–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞' }; }

        if (!res.ok || !data?.ok) {
          throw new Error(data?.details || data?.error || `API –æ—à–∏–±–∫–∞ ${res.status}`);
        }

        // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
        resultImg.src = data.url;
        resultImg.onload = () => {
          placeholder.classList.add('hidden');
          resultImg.classList.remove('hidden');
        };
        statusEl.textContent = '–ì–æ—Ç–æ–≤–æ!';
      } catch (err) {
        errorEl.textContent = String(err.message || err);
        errorEl.classList.remove('hidden');
        statusEl.textContent = '';
      } finally {
        startBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
